{"ast":null,"code":"// server.js\nconst express = require('express');\nconst cors = require('cors');\nconst fs = require('fs');\nconst path = require('path');\nconst multer = require('multer');\nconst dgram = require('dgram');\nconst {\n  WebSocketServer\n} = require('ws');\nconst http = require('http');\nconst {\n  monitorEventLoopDelay,\n  performance\n} = require('perf_hooks');\nrequire('dotenv').config();\nconst app = express();\nconst PORT = process.env.PORT || 5000;\nconst UDP_PORT = process.env.UDP_PORT || 8888;\nconst WS_PORT = process.env.WS_PORT || 5001;\n\n/* ==== CORS ==== */\nconst corsOptions = {\n  origin: true,\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization']\n};\napp.use(cors(corsOptions));\napp.options('*', cors(corsOptions));\napp.use(express.json());\n\n/* ==== Logger ==== */\napp.use((req, _res, next) => {\n  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);\n  next();\n});\n\n/* ==== Health & Root ==== */\napp.get('/health', (_req, res) => {\n  res.status(200).json({\n    ok: true,\n    port: PORT,\n    env: process.env.NODE_ENV || 'development'\n  });\n});\napp.get('/', (_req, res) => {\n  res.json({\n    message: 'Benvenuto in RACESENSE',\n    version: '3.0.1'\n  });\n});\n\n/* ==== Persistenza Piloti ==== */\nconst DATA_DIR = path.join(__dirname, 'data');\nconst UPLOAD_DIR = path.join(__dirname, 'uploads');\nconst PILOTS_DB = path.join(DATA_DIR, 'pilots.json');\n_c = PILOTS_DB;\nconst CIRCUITS_DIR = path.join(DATA_DIR, 'circuiti');\n_c2 = CIRCUITS_DIR;\nif (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, {\n  recursive: true\n});\nif (!fs.existsSync(UPLOAD_DIR)) fs.mkdirSync(UPLOAD_DIR, {\n  recursive: true\n});\nif (!fs.existsSync(PILOTS_DB)) fs.writeFileSync(PILOTS_DB, JSON.stringify([]), 'utf8');\napp.use('/uploads', express.static(UPLOAD_DIR));\nconst readPilots = () => JSON.parse(fs.readFileSync(PILOTS_DB, 'utf8'));\nconst writePilots = arr => fs.writeFileSync(PILOTS_DB, JSON.stringify(arr, null, 2), 'utf8');\nconst storage = multer.diskStorage({\n  destination: (_req, _file, cb) => cb(null, UPLOAD_DIR),\n  filename: (_req, file, cb) => {\n    const ext = path.extname(file.originalname || '').toLowerCase();\n    const base = path.basename(file.originalname || 'upload', ext).replace(/\\s+/g, '_');\n    cb(null, `${Date.now()}_${Math.random().toString(36).slice(2, 8)}_${base}${ext}`);\n  }\n});\nconst upload = multer({\n  storage,\n  limits: {\n    fileSize: 5 * 1024 * 1024\n  }\n});\n\n/* ==== API Piloti ==== */\napp.get('/api/pilots', (_req, res) => res.json(readPilots()));\napp.post('/api/pilots', upload.fields([{\n  name: 'photoDriver',\n  maxCount: 1\n}, {\n  name: 'photoTeam',\n  maxCount: 1\n}]), (req, res) => {\n  try {\n    var _req$files, _req$files$photoDrive, _req$files2, _req$files2$photoTeam;\n    const {\n      name,\n      surname,\n      team\n    } = req.body;\n    if (!name || !surname || !team) return res.status(400).json({\n      error: 'Campi obbligatori: name, surname, team'\n    });\n    let championships = [];\n    if (req.body.championships) {\n      try {\n        championships = JSON.parse(req.body.championships);\n        if (!Array.isArray(championships)) championships = [];\n      } catch {\n        championships = Array.isArray(req.body.championships) ? req.body.championships : [req.body.championships];\n      }\n    }\n    const driverFile = ((_req$files = req.files) === null || _req$files === void 0 ? void 0 : (_req$files$photoDrive = _req$files.photoDriver) === null || _req$files$photoDrive === void 0 ? void 0 : _req$files$photoDrive[0]) || null;\n    const teamFile = ((_req$files2 = req.files) === null || _req$files2 === void 0 ? void 0 : (_req$files2$photoTeam = _req$files2.photoTeam) === null || _req$files2$photoTeam === void 0 ? void 0 : _req$files2$photoTeam[0]) || null;\n    const pilot = {\n      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 8),\n      name: String(name).trim(),\n      surname: String(surname).trim(),\n      team: String(team).trim(),\n      championships,\n      photoDriverUrl: driverFile ? `/uploads/${driverFile.filename}` : null,\n      photoTeamUrl: teamFile ? `/uploads/${teamFile.filename}` : null,\n      createdAt: new Date().toISOString()\n    };\n    const pilots = readPilots();\n    pilots.unshift(pilot);\n    writePilots(pilots);\n    res.status(201).json(pilot);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({\n      error: 'Errore nel salvataggio pilota'\n    });\n  }\n});\napp.delete('/api/pilots/:id', (req, res) => {\n  try {\n    const pilots = readPilots();\n    const idx = pilots.findIndex(p => p.id === req.params.id);\n    if (idx === -1) return res.status(404).json({\n      error: 'Pilota non trovato'\n    });\n    const [removed] = pilots.splice(idx, 1);\n    writePilots(pilots);\n    const toDel = [removed.photoDriverUrl, removed.photoTeamUrl].filter(Boolean).map(u => path.join(__dirname, u.replace(/^\\//, '')));\n    toDel.forEach(fp => {\n      if (fp.startsWith(UPLOAD_DIR) && fs.existsSync(fp)) fs.unlink(fp, () => {});\n    });\n    res.json({\n      ok: true\n    });\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({\n      error: 'Errore nella cancellazione'\n    });\n  }\n});\n\n/* ==== API Circuiti ==== */\nfunction safeReadJSON(fullPath) {\n  try {\n    return JSON.parse(fs.readFileSync(fullPath, 'utf8'));\n  } catch {\n    return null;\n  }\n}\napp.get('/api/circuits', (_req, res) => {\n  try {\n    if (!fs.existsSync(CIRCUITS_DIR)) return res.json([]);\n    const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n    const list = files.map(f => {\n      var _j$meta, _j$pathPoints, _j$stats, _j$params$widthMeters, _j$params;\n      const full = path.join(CIRCUITS_DIR, f);\n      const j = safeReadJSON(full);\n      if (!j) return null;\n      return {\n        id: j.id || path.basename(f, '.json'),\n        name: j.name || path.basename(f, '.json'),\n        createdAt: j.createdAt || null,\n        points: ((_j$meta = j.meta) === null || _j$meta === void 0 ? void 0 : _j$meta.points) || ((_j$pathPoints = j.pathPoints) === null || _j$pathPoints === void 0 ? void 0 : _j$pathPoints.length) || 0,\n        lengthMeters: ((_j$stats = j.stats) === null || _j$stats === void 0 ? void 0 : _j$stats.lengthMeters) || null,\n        widthMeters: (_j$params$widthMeters = (_j$params = j.params) === null || _j$params === void 0 ? void 0 : _j$params.widthMeters) !== null && _j$params$widthMeters !== void 0 ? _j$params$widthMeters : null,\n        filename: f\n      };\n    }).filter(Boolean).sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));\n    res.json(list);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({\n      error: 'Errore lettura circuiti'\n    });\n  }\n});\napp.get('/api/circuits/:id', (req, res) => {\n  try {\n    if (!fs.existsSync(CIRCUITS_DIR)) return res.status(404).json({\n      error: 'Cartella circuiti non trovata'\n    });\n    const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n    let file = files.find(f => path.basename(f, '.json') === req.params.id);\n    let data = null;\n    if (file) {\n      data = safeReadJSON(path.join(CIRCUITS_DIR, file));\n    } else {\n      for (const f of files) {\n        const j = safeReadJSON(path.join(CIRCUITS_DIR, f));\n        if ((j === null || j === void 0 ? void 0 : j.id) === req.params.id) {\n          data = j;\n          file = f;\n          break;\n        }\n      }\n    }\n    if (!data) return res.status(404).json({\n      error: 'Circuito non trovato'\n    });\n    res.json(data);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({\n      error: 'Errore lettura circuito'\n    });\n  }\n});\n\n/* ==== WebSocket server ==== */\nconst server = http.createServer(app);\n\n// perMessageDeflate + backpressure-ready\nconst wss = new WebSocketServer({\n  port: WS_PORT,\n  perMessageDeflate: {\n    zlibDeflateOptions: {\n      level: 6\n    },\n    clientNoContextTakeover: true,\n    serverNoContextTakeover: true\n  }\n});\nconst wsClients = new Set();\n\n// === METRICHE E BROADCAST SICURO ===\nconst loop = monitorEventLoopDelay({\n  resolution: 20\n});\nloop.enable();\nconst metrics = {\n  wsClients: 0,\n  gpsPacketsPerSec: 0,\n  wsBytesPerSec: 0,\n  lastSnapshotBuildMs: 0,\n  _acc: {\n    gpsPackets: 0,\n    wsBytes: 0\n  }\n};\nwss.on('connection', ws => {\n  console.log(`[WS] Client connesso. Totale: ${wss.clients.size}`);\n  wsClients.add(ws);\n  metrics.wsClients = wss.clients.size;\n  ws.on('close', () => {\n    wsClients.delete(ws);\n    console.log(`[WS] Client disconnesso. Totale: ${wss.clients.size}`);\n    metrics.wsClients = wss.clients.size;\n  });\n  ws.on('error', err => console.error('[WS] Errore:', err.message));\n  if (Race.isActive()) {\n    // invio init con sectors UNA SOLA VOLTA alla connessione\n    try {\n      ws.send(JSON.stringify(Race.initPayload()));\n    } catch (_) {}\n  } else {\n    try {\n      ws.send(JSON.stringify({\n        type: 'race_inactive'\n      }));\n    } catch (_) {}\n  }\n});\nsetInterval(() => {\n  metrics.gpsPacketsPerSec = metrics._acc.gpsPackets;\n  metrics.wsBytesPerSec = metrics._acc.wsBytes;\n  metrics._acc.gpsPackets = 0;\n  metrics._acc.wsBytes = 0;\n}, 1000);\nfunction _broadcastString(str) {\n  const sz = Buffer.byteLength(str);\n  wsClients.forEach(c => {\n    if (c.readyState !== 1) return;\n    // backpressure: salta frame se il client è lento\n    if (c.bufferedAmount && c.bufferedAmount > 1000000) return;\n    try {\n      c.send(str);\n      metrics._acc.wsBytes += sz;\n    } catch (_) {}\n  });\n}\nfunction broadcastJSON(obj) {\n  _broadcastString(JSON.stringify(obj));\n}\n\n// throttle 20 Hz degli snapshot\nlet lastBroadcast = 0;\nfunction tryBroadcastSnapshot() {\n  const now = Date.now();\n  if (now - lastBroadcast < 50) return;\n  lastBroadcast = now;\n  const t0 = performance.now();\n  const snap = Race.snapshot();\n  metrics.lastSnapshotBuildMs = +(performance.now() - t0).toFixed(2);\n  _broadcastString(JSON.stringify(snap));\n}\n\n/* ==== UDP Listener ==== */\nconst udpServer = dgram.createSocket('udp4');\nudpServer.on('message', msg => {\n  try {\n    metrics._acc.gpsPackets++;\n\n    // Formato: MAC/LAT/LON/SATS/QUAL/SPEED_KMH/YYMMDDhhmmss[/CPUTEMP]\n    const parts = msg.toString('utf8').trim().split('/');\n    if (parts.length < 7) return;\n    const [mac, latStr, lonStr, satsStr, qualStr, speedStr, ts, cpuTempStr] = parts;\n    const gps = {\n      mac: String(mac || '').toUpperCase(),\n      lat: parseFloat(latStr),\n      lon: parseFloat(lonStr),\n      sats: parseInt(satsStr) || 0,\n      qual: parseInt(qualStr) || 0,\n      speedKmh: parseFloat(speedStr) || 0,\n      ts: ts || null,\n      cpuTemp: cpuTempStr ? parseFloat(cpuTempStr) : null,\n      receivedAt: Date.now()\n    };\n    if (Race.isActive()) {\n      Race.applyGPS(gps);\n      tryBroadcastSnapshot(); // 20Hz\n    } else {\n      broadcastJSON({\n        type: 'gps_raw',\n        data: gps\n      });\n    }\n  } catch (e) {\n    console.error('[UDP] Errore parsing:', e.message);\n  }\n});\nudpServer.on('listening', () => {\n  const addr = udpServer.address();\n  console.log(`[UDP] Listening on ${addr.address}:${addr.port} for GPS packets`);\n});\nudpServer.on('error', err => {\n  console.error('[UDP] Errore:', err);\n  udpServer.close();\n});\nudpServer.bind(UDP_PORT);\n\n/* ==== RACE ENGINE (in-memory) ==== */\nconst Race = (() => {\n  let active = false;\n  let config = null; // { circuitId, circuitData, totalLaps, assignments, pilots }\n  let raceStatus = 'IN CORSO';\n  const drivers = new Map(); // mac -> driver state\n\n  // Helpers\n  const toRad = d => d * Math.PI / 180;\n  function haversine(lat1, lon1, lat2, lon2) {\n    const R = 6371000;\n    const dLat = toRad(lat2 - lat1);\n    const dLon = toRad(lon2 - lon1);\n    const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;\n    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  }\n  function closestSector(lat, lon, sectors) {\n    let min = Infinity,\n      idx = 0;\n    for (let i = 0; i < sectors.length; i++) {\n      const s = sectors[i];\n      const d = haversine(lat, lon, s.lat, s.lon);\n      if (d < min) {\n        min = d;\n        idx = i;\n      }\n    }\n    return idx;\n  }\n  function pilotById(id) {\n    var _config;\n    return (((_config = config) === null || _config === void 0 ? void 0 : _config.pilots) || []).find(p => String(p.id) === String(id));\n  }\n  function computeLeaderboard() {\n    const arr = Array.from(drivers.values());\n    arr.sort((a, b) => {\n      if (a.lapCount !== b.lapCount) return b.lapCount - a.lapCount;\n      return b.sectorIdx - a.sectorIdx;\n    });\n    arr.forEach((d, i) => d.position = i + 1);\n    return arr;\n  }\n  function computeGaps(sorted) {\n    if (!sorted.length) return;\n    const leader = sorted[0];\n    sorted.forEach(d => {\n      if (d.mac === leader.mac) {\n        d.gapToLeader = 'LEADER';\n        return;\n      }\n      if (d.lapCount < leader.lapCount) d.gapToLeader = `+${leader.lapCount - d.lapCount}L`;else {\n        const sectorDiff = leader.sectorIdx - d.sectorIdx;\n        const est = Math.max(0, sectorDiff / 10);\n        d.gapToLeader = `+${est.toFixed(2)}`;\n      }\n    });\n  }\n  function globalBestLap() {\n    let best = null;\n    drivers.forEach(d => {\n      if (d.bestLapTime && (best === null || d.bestLapTime < best)) best = d.bestLapTime;\n    });\n    return best;\n  }\n  function penaltySummary(p) {\n    const parts = [];\n    if (p.timeSec) parts.push(`+${p.timeSec}s`);\n    if (p.warnings) parts.push(`⚠️ x${p.warnings}`);\n    if (p.dq) parts.push('DQ');\n    return parts.join('  ') || '—';\n  }\n  function nextG(prev = {\n    lat: 0,\n    long: 0,\n    vert: 0\n  }) {\n    const jitter = (x, s, min, max) => Math.max(min, Math.min(max, x + (Math.random() - 0.5) * s));\n    const lat = jitter(prev.lat, 0.2, -2.8, 2.8);\n    const lon = jitter(prev.long, 0.2, -2.8, 2.8);\n    const vert = jitter(prev.vert, 0.08, -0.9, 0.9);\n    const total = Math.sqrt(lat * lat + lon * lon + vert * vert);\n    return {\n      lat: +lat.toFixed(2),\n      long: +lon.toFixed(2),\n      vert: +vert.toFixed(2),\n      total: +total.toFixed(2)\n    };\n  }\n\n  // arrotondamenti per ridurre JSON\n  const round6 = x => Math.round((x + Number.EPSILON) * 1e6) / 1e6;\n  const round1 = x => Math.round((x + Number.EPSILON) * 10) / 10;\n\n  // payload iniziale (una tantum) con sectors\n  function makeInitPayload() {\n    var _config2, _config$circuitData, _config$circuitData2, _config$circuitData3, _config$circuitData4;\n    if (!active || !((_config2 = config) !== null && _config2 !== void 0 && _config2.circuitData)) return {\n      type: 'race_inactive'\n    };\n    return {\n      type: 'race_init',\n      ts: new Date().toISOString(),\n      totalLaps: config.totalLaps,\n      raceStatus,\n      circuit: {\n        id: config.circuitId,\n        name: ((_config$circuitData = config.circuitData) === null || _config$circuitData === void 0 ? void 0 : _config$circuitData.name) || config.circuitId,\n        stats: ((_config$circuitData2 = config.circuitData) === null || _config$circuitData2 === void 0 ? void 0 : _config$circuitData2.stats) || {},\n        params: ((_config$circuitData3 = config.circuitData) === null || _config$circuitData3 === void 0 ? void 0 : _config$circuitData3.params) || {},\n        sectors: ((_config$circuitData4 = config.circuitData) === null || _config$circuitData4 === void 0 ? void 0 : _config$circuitData4.sectors) || []\n      }\n    };\n  }\n  return {\n    isActive: () => active,\n    start: payload => {\n      var _circuitData, _circuitData$sectors;\n      if (!(payload !== null && payload !== void 0 && payload.circuitId) || !(payload !== null && payload !== void 0 && payload.assignments) || !(payload !== null && payload !== void 0 && payload.pilots)) {\n        throw new Error('Config gara incompleta');\n      }\n      // carica circuitData completo (con sectors)\n      const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n      let circuitData = null;\n      for (const f of files) {\n        const full = path.join(CIRCUITS_DIR, f);\n        const j = safeReadJSON(full);\n        if (!j) continue;\n        const id = j.id || path.basename(f, '.json');\n        if (id === payload.circuitId) {\n          circuitData = j;\n          break;\n        }\n      }\n      if (!((_circuitData = circuitData) !== null && _circuitData !== void 0 && (_circuitData$sectors = _circuitData.sectors) !== null && _circuitData$sectors !== void 0 && _circuitData$sectors.length)) throw new Error('Circuito non trovato o privo di sectors');\n      active = true;\n      raceStatus = 'IN CORSO';\n      drivers.clear();\n      config = {\n        circuitId: payload.circuitId,\n        circuitData,\n        totalLaps: Number(payload.totalLaps || 10),\n        assignments: payload.assignments,\n        pilots: payload.pilots\n      };\n      console.log('[RACE] Avviata su:', circuitData.name || config.circuitId);\n    },\n    stop: () => {\n      active = false;\n      config = null;\n      drivers.clear();\n      raceStatus = 'FINITA';\n      console.log('[RACE] Terminata');\n    },\n    applyGPS: gps => {\n      var _config3, _config3$circuitData, _config$assignments;\n      if (!active || !((_config3 = config) !== null && _config3 !== void 0 && (_config3$circuitData = _config3.circuitData) !== null && _config3$circuitData !== void 0 && _config3$circuitData.sectors)) return;\n      const {\n        mac,\n        lat,\n        lon,\n        speedKmh\n      } = gps;\n      const pilotId = (_config$assignments = config.assignments) === null || _config$assignments === void 0 ? void 0 : _config$assignments[mac];\n      if (!pilotId) return;\n      const sectors = config.circuitData.sectors;\n      const sectorIdx = closestSector(lat, lon, sectors);\n      const totalSectors = sectors.length;\n      const pilot = pilotById(pilotId);\n      if (!pilot) return;\n      const existing = drivers.get(mac) || {\n        mac,\n        pilotId,\n        fullName: `${pilot.name || ''} ${pilot.surname || ''}`.trim(),\n        tag: String((pilot.surname || '').toUpperCase()).slice(0, 4) || 'PIL',\n        team: pilot.team,\n        photoTeamUrl: pilot.photoTeamUrl || null,\n        lat,\n        lon,\n        speed: 0,\n        sectorIdx,\n        lastSectorIdx: sectorIdx,\n        lapCount: 0,\n        lapStartTime: Date.now(),\n        lastLapTime: null,\n        bestLapTime: null,\n        lapTimes: [],\n        pit: false,\n        out: false,\n        penalties: {\n          timeSec: 0,\n          warnings: 0,\n          dq: false,\n          entries: []\n        },\n        gforce: {\n          lat: 0,\n          long: 0,\n          vert: 0,\n          total: 0\n        },\n        updatedAt: Date.now()\n      };\n      let {\n        lapCount,\n        lastLapTime,\n        bestLapTime,\n        lapStartTime,\n        lapTimes\n      } = existing;\n\n      // crossing linea start\n      if (existing.lastSectorIdx > totalSectors - 10 && sectorIdx < 10) {\n        const lapSec = (Date.now() - existing.lapStartTime) / 1000;\n        if (lapSec > 5) {\n          lapCount += 1;\n          lastLapTime = lapSec;\n          bestLapTime = !bestLapTime || lapSec < bestLapTime ? lapSec : bestLapTime;\n          lapStartTime = Date.now();\n          lapTimes = [...lapTimes, +lapSec.toFixed(3)];\n        }\n      }\n      const updated = {\n        ...existing,\n        lat,\n        lon,\n        speed: speedKmh || 0,\n        sectorIdx,\n        lastSectorIdx: sectorIdx,\n        lapCount,\n        lastLapTime,\n        bestLapTime,\n        lapStartTime,\n        lapTimes,\n        gforce: nextG(existing.gforce),\n        updatedAt: Date.now()\n      };\n      drivers.set(mac, updated);\n    },\n    setStatus: status => {\n      const allowed = ['IN CORSO', 'FINITA', 'RED FLAG', 'YELLOW FLAG'];\n      if (!allowed.includes(status)) throw new Error('Stato non valido');\n      raceStatus = status;\n    },\n    applyPenalty: ({\n      mac,\n      type\n    }) => {\n      const d = drivers.get(mac);\n      if (!d) throw new Error('Pilota non trovato');\n      const p = d.penalties || {\n        timeSec: 0,\n        warnings: 0,\n        dq: false,\n        entries: []\n      };\n      if (type === '+5s' || type === '+10s' || type === '+15s') {\n        const add = parseInt(type.replace(/\\D/g, ''), 10);\n        p.timeSec += add;\n        p.entries.push({\n          type,\n          value: add,\n          ts: Date.now()\n        });\n      } else if (type === '1mo avv. squalifica') {\n        p.warnings += 1;\n        p.entries.push({\n          type,\n          value: 'WARN',\n          ts: Date.now()\n        });\n      } else if (type === 'squalifica') {\n        p.dq = true;\n        p.entries.push({\n          type,\n          value: 'DQ',\n          ts: Date.now()\n        });\n      } else {\n        throw new Error('Tipo penalità non valido');\n      }\n      d.penalties = p;\n      drivers.set(mac, d);\n    },\n    snapshot: () => {\n      var _sorted$, _config$circuitData5, _config$circuitData6, _config$circuitData7;\n      if (!active) return {\n        type: 'race_inactive'\n      };\n      const sorted = computeLeaderboard();\n      computeGaps(sorted);\n      const best = globalBestLap();\n      return {\n        type: 'race_snapshot',\n        ts: new Date().toISOString(),\n        totalLaps: config.totalLaps,\n        raceStatus,\n        leaderMac: ((_sorted$ = sorted[0]) === null || _sorted$ === void 0 ? void 0 : _sorted$.mac) || null,\n        globalBestLap: best,\n        // ATTENZIONE: niente \"sectors\" nello snapshot\n        circuit: {\n          id: config.circuitId,\n          name: ((_config$circuitData5 = config.circuitData) === null || _config$circuitData5 === void 0 ? void 0 : _config$circuitData5.name) || config.circuitId,\n          stats: ((_config$circuitData6 = config.circuitData) === null || _config$circuitData6 === void 0 ? void 0 : _config$circuitData6.stats) || {},\n          params: ((_config$circuitData7 = config.circuitData) === null || _config$circuitData7 === void 0 ? void 0 : _config$circuitData7.params) || {}\n        },\n        drivers: sorted.map(d => {\n          var _d$penalties, _d$penalties2, _d$penalties3;\n          return {\n            mac: d.mac,\n            pilotId: d.pilotId,\n            fullName: d.fullName,\n            tag: d.tag,\n            team: d.team,\n            photoTeamUrl: d.photoTeamUrl,\n            lat: round6(d.lat),\n            lon: round6(d.lon),\n            speedKmh: round1(d.speed),\n            sectorIdx: d.sectorIdx,\n            lapCount: d.lapCount,\n            lastLapTime: d.lastLapTime,\n            bestLapTime: d.bestLapTime,\n            position: d.position,\n            gapToLeader: d.gapToLeader,\n            penalty: {\n              timeSec: ((_d$penalties = d.penalties) === null || _d$penalties === void 0 ? void 0 : _d$penalties.timeSec) || 0,\n              warnings: ((_d$penalties2 = d.penalties) === null || _d$penalties2 === void 0 ? void 0 : _d$penalties2.warnings) || 0,\n              dq: !!((_d$penalties3 = d.penalties) !== null && _d$penalties3 !== void 0 && _d$penalties3.dq),\n              summary: penaltySummary(d.penalties || {})\n            },\n            gforce: d.gforce\n          };\n        })\n      };\n    },\n    getPilot: mac => {\n      var _d$penalties4, _d$penalties5, _d$penalties6;\n      if (!active) return null;\n      const d = drivers.get(String(mac).toUpperCase());\n      if (!d) return null;\n      return {\n        mac: d.mac,\n        pilotId: d.pilotId,\n        fullName: d.fullName,\n        tag: d.tag,\n        team: d.team,\n        photoTeamUrl: d.photoTeamUrl,\n        lat: d.lat,\n        lon: d.lon,\n        speedKmh: d.speed,\n        sectorIdx: d.sectorIdx,\n        lapCount: d.lapCount,\n        lastLapTime: d.lastLapTime,\n        bestLapTime: d.bestLapTime,\n        lapTimes: d.lapTimes,\n        position: d.position || null,\n        penalty: {\n          timeSec: ((_d$penalties4 = d.penalties) === null || _d$penalties4 === void 0 ? void 0 : _d$penalties4.timeSec) || 0,\n          warnings: ((_d$penalties5 = d.penalties) === null || _d$penalties5 === void 0 ? void 0 : _d$penalties5.warnings) || 0,\n          dq: !!((_d$penalties6 = d.penalties) !== null && _d$penalties6 !== void 0 && _d$penalties6.dq),\n          summary: penaltySummary(d.penalties || {})\n        },\n        gforce: d.gforce\n      };\n    },\n    initPayload: () => makeInitPayload()\n  };\n})();\n\n/* ==== API Gara ==== */\napp.post('/api/race/start', (req, res) => {\n  try {\n    if (Race.isActive()) {\n      return res.status(409).json({\n        error: 'Gara già in corso',\n        snapshot: Race.snapshot()\n      });\n    }\n    Race.start({\n      circuitId: String(req.body.circuitId),\n      totalLaps: Number(req.body.totalLaps || 10),\n      assignments: req.body.assignments || {},\n      pilots: req.body.pilots || []\n    });\n\n    // 1) init con sectors (una volta)\n    broadcastJSON(Race.initPayload());\n    // 2) primo snapshot compatto\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    metrics.lastSnapshotBuildMs = +(performance.now() - t0).toFixed(2);\n    broadcastJSON(snap);\n    res.json({\n      ok: true,\n      snapshot: snap\n    });\n  } catch (e) {\n    console.error('[RACE] start error', e.message);\n    res.status(400).json({\n      error: e.message\n    });\n  }\n});\napp.post('/api/race/stop', (_req, res) => {\n  Race.stop();\n  broadcastJSON({\n    type: 'race_inactive'\n  });\n  res.json({\n    ok: true\n  });\n});\napp.get('/api/race/state', (_req, res) => {\n  res.json(Race.snapshot());\n});\n\n/* ==== API Comandi Gara ==== */\napp.post('/api/race/status', (req, res) => {\n  try {\n    Race.setStatus(String(req.body.status));\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    broadcastJSON(snap);\n    res.json({\n      ok: true,\n      lastSnapshotBuildMs: +(performance.now() - t0).toFixed(2)\n    });\n  } catch (e) {\n    res.status(400).json({\n      error: e.message\n    });\n  }\n});\napp.post('/api/race/penalty', (req, res) => {\n  try {\n    const {\n      mac,\n      type\n    } = req.body || {};\n    Race.applyPenalty({\n      mac,\n      type\n    });\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    broadcastJSON(snap);\n    res.json({\n      ok: true,\n      lastSnapshotBuildMs: +(performance.now() - t0).toFixed(2)\n    });\n  } catch (e) {\n    res.status(400).json({\n      error: e.message\n    });\n  }\n});\n\n/* ==== API Singolo Pilota (per pagina familiari) ==== */\napp.get('/api/race/pilot/:mac', (req, res) => {\n  const mac = String(req.params.mac || '').toUpperCase();\n  const d = Race.getPilot(mac);\n  if (!d) return res.status(404).json({\n    error: 'Pilota non trovato o gara non attiva'\n  });\n  const snap = Race.snapshot();\n  res.json({\n    ok: true,\n    pilot: d,\n    circuit: snap.circuit || null,\n    // senza sectors nello snapshot\n    raceStatus: snap.raceStatus || 'IN CORSO',\n    totalLaps: snap.totalLaps || 0\n  });\n});\n\n/* ==== API Metriche ==== */\napp.get('/api/metrics', (_req, res) => {\n  res.json({\n    ok: true,\n    node: process.version,\n    rssMB: Math.round(process.memoryUsage().rss / 1024 / 1024),\n    eventLoopLagMs: +(loop.mean / 1e6).toFixed(2),\n    wsClients: metrics.wsClients,\n    gpsPacketsPerSec: metrics.gpsPacketsPerSec,\n    wsBytesPerSec: metrics.wsBytesPerSec,\n    lastSnapshotBuildMs: metrics.lastSnapshotBuildMs\n  });\n});\napp.listen(PORT, () => {\n  console.log(`RACESENSE server running on port ${PORT}`);\n  console.log(`Health: http://localhost:${PORT}/health`);\n  console.log(`WebSocket server on port ${WS_PORT}`);\n  console.log(`UDP GPS listener on port ${UDP_PORT}`);\n});\nvar _c, _c2;\n$RefreshReg$(_c, \"PILOTS_DB\");\n$RefreshReg$(_c2, \"CIRCUITS_DIR\");","map":{"version":3,"names":["express","require","cors","fs","path","multer","dgram","WebSocketServer","http","monitorEventLoopDelay","performance","config","app","PORT","process","env","UDP_PORT","WS_PORT","corsOptions","origin","credentials","methods","allowedHeaders","use","options","json","req","_res","next","console","log","Date","toISOString","method","get","_req","res","status","ok","port","NODE_ENV","message","version","DATA_DIR","join","__dirname","UPLOAD_DIR","PILOTS_DB","_c","CIRCUITS_DIR","_c2","existsSync","mkdirSync","recursive","writeFileSync","JSON","stringify","static","readPilots","parse","readFileSync","writePilots","arr","storage","diskStorage","destination","_file","cb","filename","file","ext","extname","originalname","toLowerCase","base","basename","replace","now","Math","random","toString","slice","upload","limits","fileSize","post","fields","name","maxCount","_req$files","_req$files$photoDrive","_req$files2","_req$files2$photoTeam","surname","team","body","error","championships","Array","isArray","driverFile","files","photoDriver","teamFile","photoTeam","pilot","id","String","trim","photoDriverUrl","photoTeamUrl","createdAt","pilots","unshift","e","delete","idx","findIndex","p","params","removed","splice","toDel","filter","Boolean","map","u","forEach","fp","startsWith","unlink","safeReadJSON","fullPath","readdirSync","f","endsWith","list","_j$meta","_j$pathPoints","_j$stats","_j$params$widthMeters","_j$params","full","j","points","meta","pathPoints","length","lengthMeters","stats","widthMeters","sort","a","b","localeCompare","find","data","server","createServer","wss","perMessageDeflate","zlibDeflateOptions","level","clientNoContextTakeover","serverNoContextTakeover","wsClients","Set","loop","resolution","enable","metrics","gpsPacketsPerSec","wsBytesPerSec","lastSnapshotBuildMs","_acc","gpsPackets","wsBytes","on","ws","clients","size","add","err","Race","isActive","send","initPayload","_","type","setInterval","_broadcastString","str","sz","Buffer","byteLength","c","readyState","bufferedAmount","broadcastJSON","obj","lastBroadcast","tryBroadcastSnapshot","t0","snap","snapshot","toFixed","udpServer","createSocket","msg","parts","split","mac","latStr","lonStr","satsStr","qualStr","speedStr","ts","cpuTempStr","gps","toUpperCase","lat","parseFloat","lon","sats","parseInt","qual","speedKmh","cpuTemp","receivedAt","applyGPS","addr","address","close","bind","active","raceStatus","drivers","Map","toRad","d","PI","haversine","lat1","lon1","lat2","lon2","R","dLat","dLon","sin","cos","atan2","sqrt","closestSector","sectors","min","Infinity","i","s","pilotById","_config","computeLeaderboard","from","values","lapCount","sectorIdx","position","computeGaps","sorted","leader","gapToLeader","sectorDiff","est","max","globalBestLap","best","bestLapTime","penaltySummary","timeSec","push","warnings","dq","nextG","prev","long","vert","jitter","x","total","round6","round","Number","EPSILON","round1","makeInitPayload","_config2","_config$circuitData","_config$circuitData2","_config$circuitData3","_config$circuitData4","circuitData","totalLaps","circuit","circuitId","start","payload","_circuitData","_circuitData$sectors","assignments","Error","clear","stop","_config3","_config3$circuitData","_config$assignments","pilotId","totalSectors","existing","fullName","tag","speed","lastSectorIdx","lapStartTime","lastLapTime","lapTimes","pit","out","penalties","entries","gforce","updatedAt","lapSec","updated","set","setStatus","allowed","includes","applyPenalty","value","_sorted$","_config$circuitData5","_config$circuitData6","_config$circuitData7","leaderMac","_d$penalties","_d$penalties2","_d$penalties3","penalty","summary","getPilot","_d$penalties4","_d$penalties5","_d$penalties6","node","rssMB","memoryUsage","rss","eventLoopLagMs","mean","listen","$RefreshReg$"],"sources":["/home/ubuntu/racesense/racesense-frontend/src/pages/RaceLive.jsx"],"sourcesContent":["// server.js\nconst express = require('express');\nconst cors = require('cors');\nconst fs = require('fs');\nconst path = require('path');\nconst multer = require('multer');\nconst dgram = require('dgram');\nconst { WebSocketServer } = require('ws');\nconst http = require('http');\nconst { monitorEventLoopDelay, performance } = require('perf_hooks');\nrequire('dotenv').config();\n\nconst app = express();\nconst PORT = process.env.PORT || 5000;\nconst UDP_PORT = process.env.UDP_PORT || 8888;\nconst WS_PORT = process.env.WS_PORT || 5001;\n\n/* ==== CORS ==== */\nconst corsOptions = {\n  origin: true,\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization'],\n};\napp.use(cors(corsOptions));\napp.options('*', cors(corsOptions));\napp.use(express.json());\n\n/* ==== Logger ==== */\napp.use((req, _res, next) => {\n  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);\n  next();\n});\n\n/* ==== Health & Root ==== */\napp.get('/health', (_req, res) => {\n  res.status(200).json({ ok: true, port: PORT, env: process.env.NODE_ENV || 'development' });\n});\napp.get('/', (_req, res) => {\n  res.json({ message: 'Benvenuto in RACESENSE', version: '3.0.1' });\n});\n\n/* ==== Persistenza Piloti ==== */\nconst DATA_DIR = path.join(__dirname, 'data');\nconst UPLOAD_DIR = path.join(__dirname, 'uploads');\nconst PILOTS_DB = path.join(DATA_DIR, 'pilots.json');\nconst CIRCUITS_DIR = path.join(DATA_DIR, 'circuiti');\n\nif (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });\nif (!fs.existsSync(UPLOAD_DIR)) fs.mkdirSync(UPLOAD_DIR, { recursive: true });\nif (!fs.existsSync(PILOTS_DB)) fs.writeFileSync(PILOTS_DB, JSON.stringify([]), 'utf8');\n\napp.use('/uploads', express.static(UPLOAD_DIR));\n\nconst readPilots = () => JSON.parse(fs.readFileSync(PILOTS_DB, 'utf8'));\nconst writePilots = (arr) => fs.writeFileSync(PILOTS_DB, JSON.stringify(arr, null, 2), 'utf8');\n\nconst storage = multer.diskStorage({\n  destination: (_req, _file, cb) => cb(null, UPLOAD_DIR),\n  filename: (_req, file, cb) => {\n    const ext = path.extname(file.originalname || '').toLowerCase();\n    const base = path.basename(file.originalname || 'upload', ext).replace(/\\s+/g, '_');\n    cb(null, `${Date.now()}_${Math.random().toString(36).slice(2, 8)}_${base}${ext}`);\n  }\n});\nconst upload = multer({ storage, limits: { fileSize: 5 * 1024 * 1024 } });\n\n/* ==== API Piloti ==== */\napp.get('/api/pilots', (_req, res) => res.json(readPilots()));\n\napp.post('/api/pilots', upload.fields([\n  { name: 'photoDriver', maxCount: 1 },\n  { name: 'photoTeam', maxCount: 1 }\n]), (req, res) => {\n  try {\n    const { name, surname, team } = req.body;\n    if (!name || !surname || !team) return res.status(400).json({ error: 'Campi obbligatori: name, surname, team' });\n\n    let championships = [];\n    if (req.body.championships) {\n      try {\n        championships = JSON.parse(req.body.championships);\n        if (!Array.isArray(championships)) championships = [];\n      } catch {\n        championships = Array.isArray(req.body.championships) ? req.body.championships : [req.body.championships];\n      }\n    }\n\n    const driverFile = req.files?.photoDriver?.[0] || null;\n    const teamFile = req.files?.photoTeam?.[0] || null;\n\n    const pilot = {\n      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 8),\n      name: String(name).trim(),\n      surname: String(surname).trim(),\n      team: String(team).trim(),\n      championships,\n      photoDriverUrl: driverFile ? `/uploads/${driverFile.filename}` : null,\n      photoTeamUrl: teamFile ? `/uploads/${teamFile.filename}` : null,\n      createdAt: new Date().toISOString()\n    };\n\n    const pilots = readPilots();\n    pilots.unshift(pilot);\n    writePilots(pilots);\n    res.status(201).json(pilot);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({ error: 'Errore nel salvataggio pilota' });\n  }\n});\n\napp.delete('/api/pilots/:id', (req, res) => {\n  try {\n    const pilots = readPilots();\n    const idx = pilots.findIndex(p => p.id === req.params.id);\n    if (idx === -1) return res.status(404).json({ error: 'Pilota non trovato' });\n    const [removed] = pilots.splice(idx, 1);\n    writePilots(pilots);\n\n    const toDel = [removed.photoDriverUrl, removed.photoTeamUrl].filter(Boolean)\n      .map(u => path.join(__dirname, u.replace(/^\\//, '')));\n    toDel.forEach(fp => { if (fp.startsWith(UPLOAD_DIR) && fs.existsSync(fp)) fs.unlink(fp, () => { }); });\n\n    res.json({ ok: true });\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({ error: 'Errore nella cancellazione' });\n  }\n});\n\n/* ==== API Circuiti ==== */\nfunction safeReadJSON(fullPath) {\n  try { return JSON.parse(fs.readFileSync(fullPath, 'utf8')); }\n  catch { return null; }\n}\n\napp.get('/api/circuits', (_req, res) => {\n  try {\n    if (!fs.existsSync(CIRCUITS_DIR)) return res.json([]);\n    const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n    const list = files.map(f => {\n      const full = path.join(CIRCUITS_DIR, f);\n      const j = safeReadJSON(full);\n      if (!j) return null;\n      return {\n        id: j.id || path.basename(f, '.json'),\n        name: j.name || path.basename(f, '.json'),\n        createdAt: j.createdAt || null,\n        points: j.meta?.points || j.pathPoints?.length || 0,\n        lengthMeters: j.stats?.lengthMeters || null,\n        widthMeters: j.params?.widthMeters ?? null,\n        filename: f\n      };\n    }).filter(Boolean).sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));\n    res.json(list);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({ error: 'Errore lettura circuiti' });\n  }\n});\n\napp.get('/api/circuits/:id', (req, res) => {\n  try {\n    if (!fs.existsSync(CIRCUITS_DIR)) return res.status(404).json({ error: 'Cartella circuiti non trovata' });\n    const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n\n    let file = files.find(f => path.basename(f, '.json') === req.params.id);\n    let data = null;\n    if (file) {\n      data = safeReadJSON(path.join(CIRCUITS_DIR, file));\n    } else {\n      for (const f of files) {\n        const j = safeReadJSON(path.join(CIRCUITS_DIR, f));\n        if (j?.id === req.params.id) { data = j; file = f; break; }\n      }\n    }\n    if (!data) return res.status(404).json({ error: 'Circuito non trovato' });\n    res.json(data);\n  } catch (e) {\n    console.error(e);\n    res.status(500).json({ error: 'Errore lettura circuito' });\n  }\n});\n\n/* ==== WebSocket server ==== */\nconst server = http.createServer(app);\n\n// perMessageDeflate + backpressure-ready\nconst wss = new WebSocketServer({\n  port: WS_PORT,\n  perMessageDeflate: {\n    zlibDeflateOptions: { level: 6 },\n    clientNoContextTakeover: true,\n    serverNoContextTakeover: true\n  }\n});\nconst wsClients = new Set();\n\n// === METRICHE E BROADCAST SICURO ===\nconst loop = monitorEventLoopDelay({ resolution: 20 });\nloop.enable();\n\nconst metrics = {\n  wsClients: 0,\n  gpsPacketsPerSec: 0,\n  wsBytesPerSec: 0,\n  lastSnapshotBuildMs: 0,\n  _acc: { gpsPackets: 0, wsBytes: 0 }\n};\n\nwss.on('connection', (ws) => {\n  console.log(`[WS] Client connesso. Totale: ${wss.clients.size}`);\n  wsClients.add(ws);\n  metrics.wsClients = wss.clients.size;\n\n  ws.on('close', () => {\n    wsClients.delete(ws);\n    console.log(`[WS] Client disconnesso. Totale: ${wss.clients.size}`);\n    metrics.wsClients = wss.clients.size;\n  });\n  ws.on('error', (err) => console.error('[WS] Errore:', err.message));\n\n  if (Race.isActive()) {\n    // invio init con sectors UNA SOLA VOLTA alla connessione\n    try { ws.send(JSON.stringify(Race.initPayload())); } catch (_) { }\n  } else {\n    try { ws.send(JSON.stringify({ type: 'race_inactive' })); } catch (_) { }\n  }\n});\n\nsetInterval(() => {\n  metrics.gpsPacketsPerSec = metrics._acc.gpsPackets;\n  metrics.wsBytesPerSec = metrics._acc.wsBytes;\n  metrics._acc.gpsPackets = 0;\n  metrics._acc.wsBytes = 0;\n}, 1000);\n\nfunction _broadcastString(str) {\n  const sz = Buffer.byteLength(str);\n  wsClients.forEach(c => {\n    if (c.readyState !== 1) return;\n    // backpressure: salta frame se il client è lento\n    if (c.bufferedAmount && c.bufferedAmount > 1_000_000) return;\n    try { c.send(str); metrics._acc.wsBytes += sz; } catch (_) { }\n  });\n}\nfunction broadcastJSON(obj) { _broadcastString(JSON.stringify(obj)); }\n\n// throttle 20 Hz degli snapshot\nlet lastBroadcast = 0;\nfunction tryBroadcastSnapshot() {\n  const now = Date.now();\n  if (now - lastBroadcast < 50) return;\n  lastBroadcast = now;\n  const t0 = performance.now();\n  const snap = Race.snapshot();\n  metrics.lastSnapshotBuildMs = +(performance.now() - t0).toFixed(2);\n  _broadcastString(JSON.stringify(snap));\n}\n\n/* ==== UDP Listener ==== */\nconst udpServer = dgram.createSocket('udp4');\nudpServer.on('message', (msg) => {\n  try {\n    metrics._acc.gpsPackets++;\n\n    // Formato: MAC/LAT/LON/SATS/QUAL/SPEED_KMH/YYMMDDhhmmss[/CPUTEMP]\n    const parts = msg.toString('utf8').trim().split('/');\n    if (parts.length < 7) return;\n    const [mac, latStr, lonStr, satsStr, qualStr, speedStr, ts, cpuTempStr] = parts;\n\n    const gps = {\n      mac: String(mac || '').toUpperCase(),\n      lat: parseFloat(latStr),\n      lon: parseFloat(lonStr),\n      sats: parseInt(satsStr) || 0,\n      qual: parseInt(qualStr) || 0,\n      speedKmh: parseFloat(speedStr) || 0,\n      ts: ts || null,\n      cpuTemp: cpuTempStr ? parseFloat(cpuTempStr) : null,\n      receivedAt: Date.now()\n    };\n\n    if (Race.isActive()) {\n      Race.applyGPS(gps);\n      tryBroadcastSnapshot(); // 20Hz\n    } else {\n      broadcastJSON({ type: 'gps_raw', data: gps });\n    }\n  } catch (e) {\n    console.error('[UDP] Errore parsing:', e.message);\n  }\n});\nudpServer.on('listening', () => {\n  const addr = udpServer.address();\n  console.log(`[UDP] Listening on ${addr.address}:${addr.port} for GPS packets`);\n});\nudpServer.on('error', (err) => {\n  console.error('[UDP] Errore:', err);\n  udpServer.close();\n});\nudpServer.bind(UDP_PORT);\n\n/* ==== RACE ENGINE (in-memory) ==== */\nconst Race = (() => {\n  let active = false;\n  let config = null; // { circuitId, circuitData, totalLaps, assignments, pilots }\n  let raceStatus = 'IN CORSO';\n  const drivers = new Map(); // mac -> driver state\n\n  // Helpers\n  const toRad = d => d * Math.PI / 180;\n  function haversine(lat1, lon1, lat2, lon2) {\n    const R = 6371000;\n    const dLat = toRad(lat2 - lat1);\n    const dLon = toRad(lon2 - lon1);\n    const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;\n    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  }\n  function closestSector(lat, lon, sectors) {\n    let min = Infinity, idx = 0;\n    for (let i = 0; i < sectors.length; i++) {\n      const s = sectors[i];\n      const d = haversine(lat, lon, s.lat, s.lon);\n      if (d < min) { min = d; idx = i; }\n    }\n    return idx;\n  }\n  function pilotById(id) {\n    return (config?.pilots || []).find(p => String(p.id) === String(id));\n  }\n\n  function computeLeaderboard() {\n    const arr = Array.from(drivers.values());\n    arr.sort((a, b) => {\n      if (a.lapCount !== b.lapCount) return b.lapCount - a.lapCount;\n      return b.sectorIdx - a.sectorIdx;\n    });\n    arr.forEach((d, i) => d.position = i + 1);\n    return arr;\n  }\n  function computeGaps(sorted) {\n    if (!sorted.length) return;\n    const leader = sorted[0];\n    sorted.forEach(d => {\n      if (d.mac === leader.mac) { d.gapToLeader = 'LEADER'; return; }\n      if (d.lapCount < leader.lapCount) d.gapToLeader = `+${leader.lapCount - d.lapCount}L`;\n      else {\n        const sectorDiff = leader.sectorIdx - d.sectorIdx;\n        const est = Math.max(0, sectorDiff / 10);\n        d.gapToLeader = `+${est.toFixed(2)}`;\n      }\n    });\n  }\n  function globalBestLap() {\n    let best = null;\n    drivers.forEach(d => {\n      if (d.bestLapTime && (best === null || d.bestLapTime < best)) best = d.bestLapTime;\n    });\n    return best;\n  }\n  function penaltySummary(p) {\n    const parts = [];\n    if (p.timeSec) parts.push(`+${p.timeSec}s`);\n    if (p.warnings) parts.push(`⚠️ x${p.warnings}`);\n    if (p.dq) parts.push('DQ');\n    return parts.join('  ') || '—';\n  }\n  function nextG(prev = { lat: 0, long: 0, vert: 0 }) {\n    const jitter = (x, s, min, max) => Math.max(min, Math.min(max, x + (Math.random() - 0.5) * s));\n    const lat = jitter(prev.lat, 0.2, -2.8, 2.8);\n    const lon = jitter(prev.long, 0.2, -2.8, 2.8);\n    const vert = jitter(prev.vert, 0.08, -0.9, 0.9);\n    const total = Math.sqrt(lat * lat + lon * lon + vert * vert);\n    return { lat: +lat.toFixed(2), long: +lon.toFixed(2), vert: +vert.toFixed(2), total: +total.toFixed(2) };\n  }\n\n  // arrotondamenti per ridurre JSON\n  const round6 = (x) => Math.round((x + Number.EPSILON) * 1e6) / 1e6;\n  const round1 = (x) => Math.round((x + Number.EPSILON) * 10) / 10;\n\n  // payload iniziale (una tantum) con sectors\n  function makeInitPayload() {\n    if (!active || !config?.circuitData) return { type: 'race_inactive' };\n    return {\n      type: 'race_init',\n      ts: new Date().toISOString(),\n      totalLaps: config.totalLaps,\n      raceStatus,\n      circuit: {\n        id: config.circuitId,\n        name: config.circuitData?.name || config.circuitId,\n        stats: config.circuitData?.stats || {},\n        params: config.circuitData?.params || {},\n        sectors: config.circuitData?.sectors || []\n      }\n    };\n  }\n\n  return {\n    isActive: () => active,\n    start: (payload) => {\n      if (!payload?.circuitId || !payload?.assignments || !payload?.pilots) {\n        throw new Error('Config gara incompleta');\n      }\n      // carica circuitData completo (con sectors)\n      const files = fs.readdirSync(CIRCUITS_DIR).filter(f => f.toLowerCase().endsWith('.json'));\n      let circuitData = null;\n      for (const f of files) {\n        const full = path.join(CIRCUITS_DIR, f);\n        const j = safeReadJSON(full);\n        if (!j) continue;\n        const id = j.id || path.basename(f, '.json');\n        if (id === payload.circuitId) { circuitData = j; break; }\n      }\n      if (!circuitData?.sectors?.length) throw new Error('Circuito non trovato o privo di sectors');\n\n      active = true;\n      raceStatus = 'IN CORSO';\n      drivers.clear();\n      config = {\n        circuitId: payload.circuitId,\n        circuitData,\n        totalLaps: Number(payload.totalLaps || 10),\n        assignments: payload.assignments,\n        pilots: payload.pilots\n      };\n      console.log('[RACE] Avviata su:', circuitData.name || config.circuitId);\n    },\n    stop: () => {\n      active = false;\n      config = null;\n      drivers.clear();\n      raceStatus = 'FINITA';\n      console.log('[RACE] Terminata');\n    },\n    applyGPS: (gps) => {\n      if (!active || !config?.circuitData?.sectors) return;\n      const { mac, lat, lon, speedKmh } = gps;\n      const pilotId = config.assignments?.[mac];\n      if (!pilotId) return;\n\n      const sectors = config.circuitData.sectors;\n      const sectorIdx = closestSector(lat, lon, sectors);\n      const totalSectors = sectors.length;\n      const pilot = pilotById(pilotId);\n      if (!pilot) return;\n\n      const existing = drivers.get(mac) || {\n        mac,\n        pilotId,\n        fullName: `${pilot.name || ''} ${pilot.surname || ''}`.trim(),\n        tag: String((pilot.surname || '').toUpperCase()).slice(0, 4) || 'PIL',\n        team: pilot.team,\n        photoTeamUrl: pilot.photoTeamUrl || null,\n        lat, lon, speed: 0,\n        sectorIdx,\n        lastSectorIdx: sectorIdx,\n        lapCount: 0,\n        lapStartTime: Date.now(),\n        lastLapTime: null,\n        bestLapTime: null,\n        lapTimes: [],\n        pit: false,\n        out: false,\n        penalties: { timeSec: 0, warnings: 0, dq: false, entries: [] },\n        gforce: { lat: 0, long: 0, vert: 0, total: 0 },\n        updatedAt: Date.now()\n      };\n\n      let { lapCount, lastLapTime, bestLapTime, lapStartTime, lapTimes } = existing;\n\n      // crossing linea start\n      if (existing.lastSectorIdx > totalSectors - 10 && sectorIdx < 10) {\n        const lapSec = (Date.now() - existing.lapStartTime) / 1000;\n        if (lapSec > 5) {\n          lapCount += 1;\n          lastLapTime = lapSec;\n          bestLapTime = (!bestLapTime || lapSec < bestLapTime) ? lapSec : bestLapTime;\n          lapStartTime = Date.now();\n          lapTimes = [...lapTimes, +lapSec.toFixed(3)];\n        }\n      }\n\n      const updated = {\n        ...existing,\n        lat, lon,\n        speed: speedKmh || 0,\n        sectorIdx,\n        lastSectorIdx: sectorIdx,\n        lapCount, lastLapTime, bestLapTime, lapStartTime, lapTimes,\n        gforce: nextG(existing.gforce),\n        updatedAt: Date.now()\n      };\n      drivers.set(mac, updated);\n    },\n    setStatus: (status) => {\n      const allowed = ['IN CORSO', 'FINITA', 'RED FLAG', 'YELLOW FLAG'];\n      if (!allowed.includes(status)) throw new Error('Stato non valido');\n      raceStatus = status;\n    },\n    applyPenalty: ({ mac, type }) => {\n      const d = drivers.get(mac);\n      if (!d) throw new Error('Pilota non trovato');\n      const p = d.penalties || { timeSec: 0, warnings: 0, dq: false, entries: [] };\n\n      if (type === '+5s' || type === '+10s' || type === '+15s') {\n        const add = parseInt(type.replace(/\\D/g, ''), 10);\n        p.timeSec += add; p.entries.push({ type, value: add, ts: Date.now() });\n      } else if (type === '1mo avv. squalifica') {\n        p.warnings += 1; p.entries.push({ type, value: 'WARN', ts: Date.now() });\n      } else if (type === 'squalifica') {\n        p.dq = true; p.entries.push({ type, value: 'DQ', ts: Date.now() });\n      } else {\n        throw new Error('Tipo penalità non valido');\n      }\n      d.penalties = p;\n      drivers.set(mac, d);\n    },\n    snapshot: () => {\n      if (!active) return { type: 'race_inactive' };\n      const sorted = computeLeaderboard();\n      computeGaps(sorted);\n      const best = globalBestLap();\n      return {\n        type: 'race_snapshot',\n        ts: new Date().toISOString(),\n        totalLaps: config.totalLaps,\n        raceStatus,\n        leaderMac: sorted[0]?.mac || null,\n        globalBestLap: best,\n        // ATTENZIONE: niente \"sectors\" nello snapshot\n        circuit: {\n          id: config.circuitId,\n          name: config.circuitData?.name || config.circuitId,\n          stats: config.circuitData?.stats || {},\n          params: config.circuitData?.params || {}\n        },\n        drivers: sorted.map(d => ({\n          mac: d.mac,\n          pilotId: d.pilotId,\n          fullName: d.fullName,\n          tag: d.tag,\n          team: d.team,\n          photoTeamUrl: d.photoTeamUrl,\n          lat: round6(d.lat),\n          lon: round6(d.lon),\n          speedKmh: round1(d.speed),\n          sectorIdx: d.sectorIdx,\n          lapCount: d.lapCount,\n          lastLapTime: d.lastLapTime,\n          bestLapTime: d.bestLapTime,\n          position: d.position,\n          gapToLeader: d.gapToLeader,\n          penalty: {\n            timeSec: d.penalties?.timeSec || 0,\n            warnings: d.penalties?.warnings || 0,\n            dq: !!d.penalties?.dq,\n            summary: penaltySummary(d.penalties || {})\n          },\n          gforce: d.gforce\n        }))\n      };\n    },\n    getPilot: (mac) => {\n      if (!active) return null;\n      const d = drivers.get(String(mac).toUpperCase());\n      if (!d) return null;\n      return {\n        mac: d.mac,\n        pilotId: d.pilotId,\n        fullName: d.fullName,\n        tag: d.tag,\n        team: d.team,\n        photoTeamUrl: d.photoTeamUrl,\n        lat: d.lat, lon: d.lon,\n        speedKmh: d.speed,\n        sectorIdx: d.sectorIdx,\n        lapCount: d.lapCount,\n        lastLapTime: d.lastLapTime,\n        bestLapTime: d.bestLapTime,\n        lapTimes: d.lapTimes,\n        position: d.position || null,\n        penalty: {\n          timeSec: d.penalties?.timeSec || 0,\n          warnings: d.penalties?.warnings || 0,\n          dq: !!d.penalties?.dq,\n          summary: penaltySummary(d.penalties || {})\n        },\n        gforce: d.gforce\n      };\n    },\n    initPayload: () => makeInitPayload()\n  };\n})();\n\n/* ==== API Gara ==== */\napp.post('/api/race/start', (req, res) => {\n  try {\n    if (Race.isActive()) {\n      return res.status(409).json({ error: 'Gara già in corso', snapshot: Race.snapshot() });\n    }\n    Race.start({\n      circuitId: String(req.body.circuitId),\n      totalLaps: Number(req.body.totalLaps || 10),\n      assignments: req.body.assignments || {},\n      pilots: req.body.pilots || []\n    });\n\n    // 1) init con sectors (una volta)\n    broadcastJSON(Race.initPayload());\n    // 2) primo snapshot compatto\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    metrics.lastSnapshotBuildMs = +(performance.now() - t0).toFixed(2);\n    broadcastJSON(snap);\n\n    res.json({ ok: true, snapshot: snap });\n  } catch (e) {\n    console.error('[RACE] start error', e.message);\n    res.status(400).json({ error: e.message });\n  }\n});\napp.post('/api/race/stop', (_req, res) => {\n  Race.stop();\n  broadcastJSON({ type: 'race_inactive' });\n  res.json({ ok: true });\n});\napp.get('/api/race/state', (_req, res) => {\n  res.json(Race.snapshot());\n});\n\n/* ==== API Comandi Gara ==== */\napp.post('/api/race/status', (req, res) => {\n  try {\n    Race.setStatus(String(req.body.status));\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    broadcastJSON(snap);\n    res.json({ ok: true, lastSnapshotBuildMs: +(performance.now() - t0).toFixed(2) });\n  } catch (e) {\n    res.status(400).json({ error: e.message });\n  }\n});\napp.post('/api/race/penalty', (req, res) => {\n  try {\n    const { mac, type } = req.body || {};\n    Race.applyPenalty({ mac, type });\n    const t0 = performance.now();\n    const snap = Race.snapshot();\n    broadcastJSON(snap);\n    res.json({ ok: true, lastSnapshotBuildMs: +(performance.now() - t0).toFixed(2) });\n  } catch (e) {\n    res.status(400).json({ error: e.message });\n  }\n});\n\n/* ==== API Singolo Pilota (per pagina familiari) ==== */\napp.get('/api/race/pilot/:mac', (req, res) => {\n  const mac = String(req.params.mac || '').toUpperCase();\n  const d = Race.getPilot(mac);\n  if (!d) return res.status(404).json({ error: 'Pilota non trovato o gara non attiva' });\n  const snap = Race.snapshot();\n  res.json({\n    ok: true,\n    pilot: d,\n    circuit: snap.circuit || null,     // senza sectors nello snapshot\n    raceStatus: snap.raceStatus || 'IN CORSO',\n    totalLaps: snap.totalLaps || 0\n  });\n});\n\n/* ==== API Metriche ==== */\napp.get('/api/metrics', (_req, res) => {\n  res.json({\n    ok: true,\n    node: process.version,\n    rssMB: Math.round(process.memoryUsage().rss / 1024 / 1024),\n    eventLoopLagMs: +(loop.mean / 1e6).toFixed(2),\n    wsClients: metrics.wsClients,\n    gpsPacketsPerSec: metrics.gpsPacketsPerSec,\n    wsBytesPerSec: metrics.wsBytesPerSec,\n    lastSnapshotBuildMs: metrics.lastSnapshotBuildMs\n  });\n});\n\napp.listen(PORT, () => {\n  console.log(`RACESENSE server running on port ${PORT}`);\n  console.log(`Health: http://localhost:${PORT}/health`);\n  console.log(`WebSocket server on port ${WS_PORT}`);\n  console.log(`UDP GPS listener on port ${UDP_PORT}`);\n});\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}